{% extends "index.html" %}
{% block content %}
{% load static %}

<div class="container-fluid py-4">
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}
  <div class="card shadow border-0">
    <div class="card-header bg-gradient-info pb-3 border-radius-lg d-flex justify-content-between align-items-center">
      <div>
        <h4 class="text-white mb-0">Transactions</h4>
        <p class="text-white-50 mb-0">Your recent transactions</p>
      </div>
      <a href="{% url 'add_transaction' %}" class="btn btn-light text-info fw-bold">Add Transaction</a>
    </div>
    <div class="card-body">
      <!-- Filter Dropdowns -->
      <div class="row mb-3">
        <div class="col-md-3">
          <label for="filterTransactionNumber" class="form-label">Transaction Number</label>
          <select id="filterTransactionNumber" class="form-select">
            <option value="">All</option>
            {% for transaction in transactions %}
              <option value="{{ transaction.transaction_number }}">{{ transaction.transaction_number }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label for="filterType" class="form-label">Type</label>
          <select id="filterType" class="form-select">
            <option value="">All</option>
            {% for transaction in transactions %}
              <option value="{{ transaction.type }}">{{ transaction.type }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label for="filterTenant" class="form-label">Tenant</label>
          <select id="filterTenant" class="form-select">
            <option value="">All</option>
            {% for transaction in transactions %}
              <option value="{{ transaction.tenant }}">{{ transaction.tenant }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label for="filterProperty" class="form-label">Property</label>
          <select id="filterProperty" class="form-select">
            <option value="">All</option>
            {% for transaction in transactions %}
              <option value="{{ transaction.property }}">{{ transaction.property }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-3">
          <label for="filterFromDate" class="form-label">From Date</label>
          <input type="date" id="filterFromDate" class="form-control">
        </div>
        <div class="col-md-3">
          <label for="filterToDate" class="form-label">To Date</label>
          <input type="date" id="filterToDate" class="form-control">
        </div>
      </div>
      <!-- Transactions Table -->
      <div class="table-responsive">
        <table class="table align-middle mb-0" id="transactionsTable">
          <thead class="text-center">
            <tr>
              <th>
                <p class="text-center font-weight-bold mb-0">Date</p>
                <p class="text-center text-secondary mb-0">Type</p>
              </th>
              <th>
                <p class="text-center font-weight-bold mb-0">Transaction #</p>
                <p class="text-center text-secondary mb-0">Amount</p>
              </th>
              <th>
                <p class="text-center font-weight-bold mb-0">Property</p>
                <p class="text-center text-secondary mb-0">Tenant</p>
              </th>
              <th>Description</th>
              <th>View/Download</th>
            </tr>
          </thead>
          <tbody>
            {% for transaction in transactions %}
            <tr>
              <td>
                <div class="d-flex px-2 py-1">
                  <div>
                    <img src="/static/assets/img/team-2.jpg" class="avatar avatar-sm me-3" alt="user1">
                  </div>
                  <div class="d-flex flex-column justify-content-center">
                    <h6 class="mb-0 text-sm">{{ transaction.created_at|date:"d-M-Y" }}</h6>
                    <p class="text-xs text-secondary mb-0">{{ transaction.type }}</p>
                  </div>
                </div>
              </td>
              <td>
                <p class="text-xs text-center font-weight-bold mb-0">{{ transaction.transaction_number }}</p>
                <p class="text-xs text-center text-secondary mb-0">${{ transaction.amount }}</p>
              </td>
              <td>
                <p class="text-xs text-center font-weight-bold mb-0">{{ transaction.property }}</p>
                <p class="text-xs text-center text-secondary mb-0">{{ transaction.tenant }}</p>
              </td>
              <td class="text-sm text-center">{{ transaction.description }}</td>
              <td class="text-center">
                <a href="{% url 'transaction_pdf' transaction.id %}" title="Download PDF">
                  <i class="bi bi-filetype-pdf fs-3"></i>
                </a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="text-center">No transactions found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const filterInputs = {
      transactionNumber: document.getElementById('filterTransactionNumber'),
      type: document.getElementById('filterType'),
      tenant: document.getElementById('filterTenant'),
      property: document.getElementById('filterProperty'),
      fromDate: document.getElementById('filterFromDate'),
      toDate: document.getElementById('filterToDate'),
    };

    const table = document.getElementById('transactionsTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

    // Function to filter rows
    function filterTable() {
      for (let row of rows) {
        let showRow = true;

        // Check each filter input
        if (filterInputs.transactionNumber.value) {
          const cell = row.cells[1].textContent.toLowerCase();
          showRow = cell.includes(filterInputs.transactionNumber.value.toLowerCase());
        }
        if (showRow && filterInputs.type.value) {
          const cell = row.cells[0].textContent.toLowerCase();
          showRow = cell.includes(filterInputs.type.value.toLowerCase());
        }
        if (showRow && filterInputs.tenant.value) {
          const cell = row.cells[2].textContent.toLowerCase();
          showRow = cell.includes(filterInputs.tenant.value.toLowerCase());
        }
        if (showRow && filterInputs.property.value) {
          const cell = row.cells[2].textContent.toLowerCase();
          showRow = cell.includes(filterInputs.property.value.toLowerCase());
        }

        // Check date range
        if (showRow && (filterInputs.fromDate.value || filterInputs.toDate.value)) {
          const dateCell = row.cells[0].textContent; // Assuming the date is in the 1st column
          const rowDate = new Date(dateCell.split('-').reverse().join('-')); // Convert "d-M-Y" to "Y-m-d"
          const fromDate = filterInputs.fromDate.value ? new Date(filterInputs.fromDate.value) : null;
          const toDate = filterInputs.toDate.value ? new Date(filterInputs.toDate.value) : null;

          if (fromDate && rowDate < fromDate) {
            showRow = false;
          }
          if (toDate && rowDate > toDate) {
            showRow = false;
          }
        }

        // Show or hide the row
        row.style.display = showRow ? '' : 'none';
      }
    }

    // Add event listeners to filter inputs
    for (let key in filterInputs) {
      if (filterInputs[key]) {
        filterInputs[key].addEventListener('change', filterTable);
      }
    }
  });
</script>
{% endblock %}